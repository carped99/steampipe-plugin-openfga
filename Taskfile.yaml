version: '3'

tasks:
  openfga:
    desc: Generate the openfga module
    cmds:
      - docker run --rm -v "{{.TASKFILE_DIR}}/internal/openfga:/workspace" -w /workspace bufbuild/buf generate

  steampipe:
    desc: Run Docker steampipe image
    deps: [ steampipe-build ]
    cmds:
      - docker compose -f "{{.ROOT_DIR}}/docker/docker-compose.yaml" up -d
      - docker run --rm --network=steampipe-openfga_default -e STEAMPIPE_LOG_LEVEL=trace -it steampipe-openfga

  steampipe-build:
    internal: true
    desc: Build Docker steampipe image
    cmds:
      - docker build -f "{{.ROOT_DIR}}/docker/Dockerfile-steampipe" -t steampipe-openfga "{{.ROOT_DIR}}"
      - echo "✅ Docker image built successfully"

  standalone:
    desc: Build standalone PostgreSQL FDW image
    cmds:
      - docker build -f "{{.ROOT_DIR}}/Dockerfile-standalone" -t steampipe-acl-fdw "{{.ROOT_DIR}}"
      - echo "✅ Standalone FDW image built successfully"
      - echo ""
      - echo "To run:"
      - echo "  task standalone:up"
      - echo "  psql -h localhost -U steampipe -d steampipe"

#  standalone:up:
#    desc: Start standalone FDW stack with docker-compose
#    deps: [ standalone ]
#    cmds:
#      - docker compose -f "{{.ROOT_DIR}}/docker/docker-compose-standalone.yaml" up -d
#      - echo "✅ Standalone FDW stack started"
#      - echo ""
#      - echo "Connection info:"
#      - echo "  Host:     localhost"
#      - echo "  Port:     5432"
#      - echo "  Database: steampipe"
#      - echo "  User:     steampipe"
#      - echo "  Password: steampipe"
#      - echo ""
#      - echo "Test connection:"
#      - echo "  psql -h localhost -U steampipe -d steampipe"
#
#  standalone:down:
#    desc: Stop standalone FDW stack
#    cmds:
#      - docker compose -f "{{.ROOT_DIR}}/docker/docker-compose-standalone.yaml" down
#
#  standalone:logs:
#    desc: View standalone FDW logs
#    cmds:
#      - docker compose -f "{{.ROOT_DIR}}/docker/docker-compose-standalone.yaml" logs -f

  testdata:
    desc: Generate test data using testdata.json configuration
    dir: "{{.ROOT_DIR}}/testdata"
    cmds:
      - go run generator.go testdata_generator.go

  test:
    desc: Run tests
    cmds:
      - go test ./... -v

  test:integration:
    desc: Run integration tests
    cmds:
      - OPENFGA_API_URL=http://localhost:8080 OPENFGA_STORE_ID={{.OPENFGA_STORE_ID}} go test ./acl/... -v -run Integration
